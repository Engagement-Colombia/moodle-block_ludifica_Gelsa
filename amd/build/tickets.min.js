define(["jquery","core/notification","core/str","core/ajax","block_ludifica/alertc","block_ludifica/player","core/modal_factory","core/log"],function(a,c,t,o,n,l,d,u){var r=[],s=null;function f(t){var e=a("<div></div>"),i=a('<select id="block_ludifica_ticket_given_contact" class="form-control"></select>');e.append("<h4>"+r.giveticketmessage+"</h4>"),s.forEach(e=>{i.append('<option value="'+e.id+'">'+e.name+"</option>")}),e.append(i),c.confirm(r.giveticket,e.html(),r.give,r.cancel,function(){var e=parseInt(a("#block_ludifica_ticket_given_contact").val());o.call([{methodname:"block_ludifica_give_ticket",args:{ticketid:t,contactid:e},done:function(e){e?(n.success(r.given),k(t)):n.error(r.notgive)},fail:function(e){n.error(e.message),u.debug(e)}}])})}function k(n){o.call([{methodname:"block_ludifica_get_ticket",args:{id:n},done:function(e){var t,i,c,o;e&&"object"==typeof e&&(t=a("#ticket-"+n),i=a("#moreinfo-ticket-content-"+n+" .usertickets"),c=i.find("ul"),o=0,t.find('val[key="available"]').html(e.available),t.find('val[key="usertickets"]').html(e.usertickets.length),c.empty(),0<e.usertickets.length?(t.find('[data-action="give"]').show(),i.show(),e.usertickets.forEach(e=>{var t=a('<li class="list-group-item"></li>'),i=a('<span class="usercode">'+e.usercode+" </span>");t.append(i),e.timeused&&(i.addClass("usercode-used"),i=r.usedat.replace("USERDATE",e.timeusedformatted),i=a("<em> "+i+"</em>"),t.append(i)),c.append(t),e.timeused||o++})):i.hide(),0==o&&t.find('[data-action="give"]').hide(),e.available<=0||e.byuser<=e.usertickets.length?t.find('[data-action="buy"]').hide():t.find('[data-action="buy"]').show())},fail:function(e){u.debug(e)}}])}return{init:function(e){var i=[{key:"buyticket",component:"block_ludifica"},{key:"buyticketmessage",component:"block_ludifica"},{key:"buy",component:"block_ludifica"},{key:"notbuy",component:"block_ludifica"},{key:"give",component:"block_ludifica"},{key:"given",component:"block_ludifica"},{key:"notgive",component:"block_ludifica"},{key:"giveticket",component:"block_ludifica"},{key:"giveticketmessage",component:"block_ludifica"},{key:"notcontacts",component:"block_ludifica"},{key:"bought",component:"block_ludifica"},{key:"usedat",component:"block_ludifica",param:"USERDATE"},{key:"cancel"},{key:"continue"},{key:"error"},{key:"info"}];i.forEach(function(e){r[e.key]=e.key}),t.get_strings(i).then(function(e){return e.forEach(function(e,t){r[i[t].key]=e}),!0}).fail(function(e){u.debug("Error loading strings"),u.debug(e)}),a('[data-action="buy"]').on("click",function(){var t=a(this).data("id");c.confirm(r.buyticket,r.buyticketmessage,r.buy,r.cancel,function(){o.call([{methodname:"block_ludifica_buy_ticket",args:{id:t},done:function(e){e?(n.success(r.bought),k(t),l.reloadStats()):n.error(r.notbuy)},fail:function(e){u.debug("Error buy ticket"),u.debug(e)}}])})}),a('[data-action="give"]').on("click",function(){var t=a(this).data("id");s?f(t):o.call([{methodname:"core_message_get_user_contacts",args:{userid:e},done:function(e){e&&"object"==typeof e&&0<e.length?(s=[],e.forEach(e=>{e.isdeleted||e.isblocked||!e.iscontact||s.push({name:e.fullname,id:e.id})}),f(t)):n.warning(r.notcontacts)},fail:function(e){n.error(e.message),u.debug(e)}}])}),a('[data-action="showmore"]').on("click",function(){var e=a(this).data("id"),e=a("#moreinfo-ticket-"+e),e={title:e.attr("title"),body:e.html()};d.create(e).then(function(e){return e.show(),!0}).fail(function(e){u.debug("Error creating modal showmore"),u.debug(e)})})}}});
//# sourceMappingURL=tickets.min.js.map